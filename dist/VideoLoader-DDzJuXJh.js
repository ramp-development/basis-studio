import{E as c}from"./app.js";class h extends c{constructor(e,t,i={}){super(),t&&typeof t=="object"&&!t.moduleLoader&&!t.scroll&&(t.timeout||t.lazyLoad!==void 0||t.rootMargin||t.threshold)&&(i=t,t=null),this.video=e.tagName==="VIDEO"?e:e.querySelector("video"),this.instance=e,this.app=t,this.options={timeout:i.timeout||15e3,lazyLoad:i.lazyLoad!==!1,rootMargin:i.rootMargin||"100px",threshold:i.threshold||.1},this.isLoaded=!1,this.isInView=!1,this.observer=null,this.loadingIndicator=null,this.isMobile=window.innerWidth<=992,this.isLowPowerMode=this.detectLowPowerMode(),this.video._videoLoaderInstance=this,this.isWebGLVideo=this.detectWebGLVideo(),this.source=this.video.querySelector("source");const s=this.source.getAttribute("data-src-mobile")||this.source.dataset.srcMobile,o=this.source.getAttribute("data-src")||this.source.dataset.src;this.src=this.isMobile&&s?s:o,(!this.options.lazyLoad||this.isWebGLVideo)&&this.source.setAttribute("src",this.src),this.init()}detectWebGLVideo(){const e=[".double-video",".cases_video",".preview_img",".talk_full"],t=this.video===this.instance?this.video.parentElement:this.instance;return e.some(i=>{const s=i.substring(1);if(t&&t.classList.contains(s))return!0;let o=t==null?void 0:t.parentElement;for(;o;){if(o.classList.contains(s))return!0;o=o.parentElement}return!1})}getCustomAspectRatio(){const e=[".double-video",".case_split-video"],t=this.video===this.instance?this.video.parentElement:this.instance,i=this.findContainerWithClass(t,e);if(!i)return null;const s=i.dataset.aspectMobile,o=i.dataset.aspect;let r,n;if(this.isMobile&&s?(r=s,n="data-aspect-mobile"):o&&(r=o,n="data-aspect"),r){const d=this.parseAspectRatio(r);if(d)return{width:d.width,height:d.height,ratio:d.ratio,source:n}}const a=this.getAspectRatioFromCSS(i);return a?{width:a.width,height:a.height,ratio:a.ratio,source:"CSS aspect-ratio"}:null}findContainerWithClass(e,t){let i=e;for(;i;){for(const s of t){const o=s.substring(1);if(i.classList&&i.classList.contains(o))return i}i=i.parentElement}return null}parseAspectRatio(e){if(!e)return null;if(e.includes(":")){const[i,s]=e.split(":").map(Number);if(i&&s)return{width:i,height:s,ratio:i/s}}if(e.includes("/")){const[i,s]=e.split("/").map(Number);if(i&&s)return{width:i,height:s,ratio:i/s}}const t=parseFloat(e);return!isNaN(t)&&t>0?{ratio:t,width:null,height:null}:null}getAspectRatioFromCSS(e){try{const i=window.getComputedStyle(e).getPropertyValue("aspect-ratio");return!i||i==="auto"?null:this.parseAspectRatio(i.replace(/\s+/g,""))}catch(t){return console.warn("Failed to read CSS aspect-ratio:",t),null}}init(){if(this.video.readyState>=3){this.isLoaded=!0,this.trigger("loaded"),this.setupDOMPlayback();return}!this.isMobile&&(this.isWebGLVideo||!this.options.lazyLoad)?this.startLoading():this.setupIntersectionObserver()}detectLowPowerMode(){if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return!0;if(navigator.connection){const e=navigator.connection;return e.saveData||e.effectiveType==="slow-2g"||e.effectiveType==="2g"}return!1}setupIntersectionObserver(){if(!("IntersectionObserver"in window)){this.startLoading();return}this.observer=new IntersectionObserver(e=>{e.forEach(t=>{t.isIntersecting&&!this.isLoaded&&!this.isInView&&(this.isInView=!0,this.startLoading())})},{rootMargin:this.options.rootMargin,threshold:this.options.threshold}),this.observer.observe(this.video)}startLoading(){performance.now(),this.source.getAttribute("src")||this.source.setAttribute("src",this.src),this.setOptimalPreloadBehavior(),this.video.load(),this.addEventListeners(),this.startTimeout()}setOptimalPreloadBehavior(){this.isMobile||this.isLowPowerMode?(this.video.preload="metadata",this.setupUserInteractionUpgrade()):this.video.preload="auto"}setupUserInteractionUpgrade(){const e=t=>{this.video.preload="auto",this.video.load(),document.removeEventListener("touchstart",e,{passive:!0}),document.removeEventListener("scroll",e,{passive:!0}),document.removeEventListener("click",e)};document.addEventListener("touchstart",t=>e(),{passive:!0,once:!0}),document.addEventListener("scroll",t=>e(),{passive:!0,once:!0}),document.addEventListener("click",t=>e(),{once:!0})}addEventListeners(){this.video.addEventListener("canplaythrough",()=>{this.onVideoLoaded()},{once:!0}),this.video.addEventListener("error",e=>{this.onVideoError(e)},{once:!0})}startTimeout(){this.timeout=setTimeout(()=>{this.isLoaded||(console.warn("Video load timeout - proceeding anyway"),this.onVideoLoaded(!0))},this.options.timeout)}onVideoLoaded(){if(this.isLoaded)return;this.isLoaded=!0,clearTimeout(this.timeout),this.observer&&(this.observer.disconnect(),this.observer=null);const e=this.isMobile?this.getCustomAspectRatio():null;e&&e.width&&e.height?(this.width=e.width,this.height=e.height):(this.width=this.video.videoWidth,this.height=this.video.videoHeight),this.setupDOMPlayback(),this.trigger("loaded")}setupDOMPlayback(){this.isWebGLVideo||(this.video.getAttribute("autoplay")==="true"?this.playVideo():(this.video.currentTime=0,this.video.pause())),this.video.classList.add("loaded")}playVideo(){this.video.paused&&this.video.play().catch(e=>{console.warn("Video autoplay failed:",e)})}onVideoError(e){clearTimeout(this.timeout),console.error("Error loading video:",e),this.observer&&(this.observer.disconnect(),this.observer=null),this.trigger("error")}waitForLoad(){return new Promise((e,t)=>{if(this.isLoaded){e(this.video);return}this.on("loaded",()=>e(this.video)),this.on("error",i=>t(i.error))})}destroy(){clearTimeout(this.timeout),this.observer&&(this.observer.disconnect(),this.observer=null),this.video&&(this.video._videoLoaderInstance=null,this.video.paused||this.video.pause()),this.off(),this.video=null,this.source=null}static optimizeMultipleVideos(e,t={}){const i=[],s=t.mobileThreshold||992;return window.innerWidth<=s&&e.length>3?e.forEach((r,n)=>{setTimeout(()=>{const a=new h(r,{...t,lazyLoad:!0,rootMargin:n<2?"50px":"200px"});i.push(a)},n*500)}):e.forEach(r=>{const n=new h(r,t);i.push(n)}),i}}export{h as default};
